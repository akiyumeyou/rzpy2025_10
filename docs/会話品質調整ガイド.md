# 音声会話品質調整ガイド

**最終更新**: 2025年9月30日  
**対象ファイル**: `modules/audio_handler.py`

このドキュメントは、OpenAI Realtime APIを使用した音声会話システムの品質を調整するための実践的なガイドです。

---

## 📖 目次

1. [Realtime API パラメータ完全リファレンス](#realtime-api-パラメータ完全リファレンス)
2. [よくある問題と解決方法](#よくある問題と解決方法)
3. [調整箇所一覧](#調整箇所一覧)
4. [設定値の一覧表](#設定値の一覧表)
5. [調整の手順](#調整の手順)
6. [トラブルシューティング](#トラブルシューティング)
7. [設定例](#設定例)

---

## 📖 Realtime API パラメータ完全リファレンス

### 主要パラメータ一覧

OpenAI Realtime APIの`session_config`で設定できるパラメータの完全な説明です。

#### 1. `modalities` - 応答形式の指定

| パラメータ | 説明 | 設定値 | 推奨値 |
|-----------|------|--------|--------|
| `modalities` | AIが返す応答の形式を指定 | `["text"]`, `["audio"]`, `["text", "audio"]` | **`["audio", "text"]`** |

**詳細**:
- `["text"]`: テキストのみ（音声なし）
- `["audio"]`: 音声のみ（テキストなし）
- `["text", "audio"]`: **両方返す（推奨）** - 音声とテキストを同時に取得できる

**使用例**:
```python
"modalities": ["audio", "text"]  # 音声チャットアプリでは両方を推奨
```

---

#### 2. `input_audio_format` / `output_audio_format` - 音声フォーマット

| パラメータ | 説明 | 設定値 | 推奨値 |
|-----------|------|--------|--------|
| `input_audio_format` | 入力音声のフォーマット | `"pcm16"`, `"g711_ulaw"`, `"g711_alaw"` | **`"pcm16"`** |
| `output_audio_format` | 出力音声のフォーマット | `"pcm16"`, `"g711_ulaw"`, `"g711_alaw"` | **`"pcm16"`** |

**重要**: サーバとクライアントでサンプルレートやビット深度が一致しないと、音声が速く/遅く再生されたり、認識精度が落ちます。

**設定例**:
```python
"input_audio_format": "pcm16",   # 16-bit PCM（高品質）
"output_audio_format": "pcm16",  # 入出力を統一
```

**対応するPyAudio設定**:
```python
# audio_handler.py の音声設定と一致させる
format = pyaudio.paInt16  # pcm16に対応
rate = 24000              # 24kHzサンプリングレート
channels = 1              # モノラル
```

---

#### 3. `turn_detection` - 発話終端検出設定

##### 3-1. `turn_detection.type` - 検出方式

| パラメータ | 説明 | 設定値 | 推奨値 |
|-----------|------|--------|--------|
| `turn_detection.type` | ユーザーの発話終端をどう検出するか | `"server_vad"`, `"none"` | **`"server_vad"`** |

**詳細**:
- `"server_vad"`: サーバー側で無音検出して自動で応答を開始（推奨）
- `"none"`: クライアント側で明示的に `input_audio_buffer.commit()` を呼び出す必要がある

---

##### 3-2. `turn_detection.threshold` - 音声検出感度

| パラメータ | 説明 | 範囲 | 推奨値 |
|-----------|------|------|--------|
| `turn_detection.threshold` | 音声検出感度 | `0.0`（敏感）〜 `1.0`（鈍感） | **`0.85`** |

**数値による変化**:

| 値 | 感度 | 動作 | 適用シーン | 問題点 |
|----|------|------|-----------|--------|
| `0.3` | 超敏感 | 非常に小さな音も拾う | 完全に静かな環境 | 物音、呼吸音でも反応してしまう |
| `0.5` | 高感度 | 小さめの声も拾う | 静かな室内 | 生活音で誤検知しやすい |
| `0.7` | **標準** | 普通の声量で反応 | 一般的な環境 | やや誤検知あり |
| `0.85` | **推奨** | はっきりした声のみ | 生活音がある環境 | 物音に反応しにくい |
| `0.9` | 低感度 | 大きめの声のみ | 騒がしい環境 | 小さな声は拾えない |
| `0.95` | 鈍感 | かなり大きな声のみ | 非常に騒がしい環境 | 普通の声では反応しない |

**設定例**:
```python
"threshold": 0.85  # 物音に反応しにくく、AI応答中の割り込みを防ぐ
```

---

##### 3-3. `turn_detection.silence_duration_ms` - 無音判定時間

| パラメータ | 説明 | 単位 | 標準範囲 | 推奨値 |
|-----------|------|------|----------|--------|
| `turn_detection.silence_duration_ms` | この時間無音が続いたら発話終了と判定 | ミリ秒 | `500-2000ms` | **`1500ms`** |

**数値による変化**:

| 値 | 動作 | 適用シーン | メリット | デメリット |
|----|------|-----------|----------|----------|
| `300ms` | 超高速 | 若年層向けテンポの速い会話 | 非常にスムーズ | 発話途中で切られる |
| `500ms` | 高速 | 普通のテンポの会話 | テンポが良い | ゆっくり話すと途中で切られる |
| `700ms` | **標準** | 一般的な会話 | 自然な会話リズム | 高齢者には少し早い |
| `1000ms` | ゆっくり | 落ち着いた会話 | 余裕がある | やや間が長く感じる |
| `1500ms` | **推奨（高齢者向け）** | ゆっくり話す人向け | 途中で切られない | AI応答までやや時間がかかる |
| `2000ms` | 超ゆっくり | 発話が途切れがちな人 | 確実に最後まで聞ける | 会話のテンポが遅い |
| `2500ms` | 極度にゆっくり | 言葉が出にくい人 | 焦らず話せる | かなり間が長い |

**重要**: 
- **短すぎる** → ユーザーの発話途中でAIが割り込む
- **長すぎる** → AI応答が遅く感じる、会話のテンポが悪い
- **最適値**: 700ms（標準）、1500ms（高齢者向け推奨）

**設定例**:
```python
"silence_duration_ms": 1500  # 高齢者がゆっくり話すのを待つ
```

---

##### 3-4. `turn_detection.prefix_padding_ms` - 発話前バッファ

| パラメータ | 説明 | 単位 | 標準範囲 | 推奨値 |
|-----------|------|------|----------|--------|
| `turn_detection.prefix_padding_ms` | 音声検知より何ms前から録音を開始するか | ミリ秒 | `200-700ms` | **`500ms`** |

**数値による変化**:

| 値 | 動作 | メリット | デメリット |
|----|------|----------|----------|
| `100ms` | 短い | 無駄な音を拾わない | 発話の頭（「あ」「え」）が切れる |
| `300ms` | **標準** | バランスが良い | 発話が急だと頭が切れることも |
| `500ms` | **推奨** | 発話の頭が確実に残る | 発話前の雑音を拾う可能性 |
| `700ms` | 長い | 発話の頭を絶対に逃さない | 無関係な音も録音される |

**設定例**:
```python
"prefix_padding_ms": 500  # 発話の頭（「あのー」など）が切れないよう余裕を持つ
```

---

#### 4. `input_audio_transcription` - 音声テキスト化設定

| パラメータ | 説明 | 設定値 | 推奨値 |
|-----------|------|--------|--------|
| `input_audio_transcription.model` | 音声認識モデル | `"whisper-1"` | **`"whisper-1"`** |
| `input_audio_transcription.language` | 認識言語 | ISO言語コード | **`"ja"`** |

**設定例**:
```python
"input_audio_transcription": {
    "model": "whisper-1",
    "language": "ja"  # 日本語に最適化
}
```

---

#### 5. `voice` - AIの音声（声質）

| パラメータ | 説明 | 設定値 | 推奨値 |
|-----------|------|--------|--------|
| `voice` | AIの声質を指定 | `"alloy"`, `"echo"`, `"shimmer"`, `"ash"`, `"ballad"`, `"coral"`, `"sage"`, `"verse"` | **`"shimmer"`** |

**各音声の特徴**:

| 音声名 | 特徴 | 適用シーン |
|--------|------|-----------|
| `"alloy"` | 中性的、クリア | 標準的な用途 |
| `"echo"` | 男性的、落ち着いた | ビジネス・説明 |
| `"shimmer"` | **女性的、温かい（推奨）** | 高齢者向け・共感的な会話 |
| `"ash"` | 落ち着いた男性声 | 解説・ナレーション |
| `"ballad"` | 柔らかい中性声 | リラックスした会話 |
| `"coral"` | 明るい女性声 | 活気のある会話 |
| `"sage"` | 知的な男性声 | 専門的な説明 |
| `"verse"` | ニュートラル | 汎用的な用途 |

**設定例**:
```python
"voice": "shimmer"  # 温かみのある女性声（高齢者向け推奨）
```

---

#### 6. `temperature` - 応答のランダム性

| パラメータ | 説明 | 範囲 | 推奨値 |
|-----------|------|------|--------|
| `temperature` | 応答の創造性・ランダム性 | `0.0`（決定的）〜 `1.0`（創造的） | **`0.7`** |

**数値による変化**:

| 値 | 動作 | 適用シーン |
|----|------|-----------|
| `0.0-0.3` | 非常に決定的、同じ質問には同じ答え | FAQ、事実確認 |
| `0.4-0.6` | やや保守的、一貫性重視 | 正確性が重要な場面 |
| `0.7` | **標準（推奨）** | 自然な会話 |
| `0.8-1.0` | 創造的、多様な応答 | 雑談、創作 |

**設定例**:
```python
"temperature": 0.7  # 自然な会話に最適
```

---

#### 7. `max_response_output_tokens` - 応答の最大長

| パラメータ | 説明 | 範囲 | 推奨値 |
|-----------|------|------|--------|
| `max_response_output_tokens` | AI応答の最大トークン数 | `1-4096` | **`150`** |

**数値による変化**:

| 値 | 応答の長さ | 適用シーン | 問題点 |
|----|----------|-----------|--------|
| `50` | 非常に短い（1文程度） | 相槌のみ | 説明が不十分 |
| `100` | 短い（1〜2文） | 簡潔な応答 | 途中で切れることも |
| `150` | **標準（推奨）** | 適度な長さ | バランスが良い |
| `200` | やや長い（2〜3文） | 詳しい説明 | 長すぎると感じることも |
| `300+` | 長い（3文以上） | 詳細な解説 | 高齢者には長すぎる |

**設定例**:
```python
"max_response_output_tokens": 150  # 1〜2文、途中で切れない余裕
```

---

#### 8. `instructions` - AIの振る舞い指示

| パラメータ | 説明 | 型 | 重要度 |
|-----------|------|---|--------|
| `instructions` | AIの振る舞いを決めるプロンプト | 文字列 | **最重要** |

**役割**:
- 会話のトーン（丁寧、親しみやすい、など）
- 応答スタイル（短く、ゆっくり、など）
- 制約（特定の話題を避ける、など）

**設定例**（高齢者向け）:
```python
"instructions": """
あなたは高齢者と会話する優しい聞き役です。
【重要】ゆっくり、はっきり、落ち着いた調子で話してください。
1文ずつ区切って、間を取りながら話します。
必ず1〜2文以内の短い応答で、相槌や共感を最優先してください。
"""
```

**詳細**: 👉 [プロンプト設計ガイド](prompt_design.md)

---

#### 9. `interrupt_response` - 割り込み設定（⚠️ 注意）

| パラメータ | 説明 | 設定値 | 推奨値 |
|-----------|------|--------|--------|
| `interrupt_response` | AI応答中にユーザーが話し始めたら応答を中断するか | `true`, `false` | **設定しない（デフォルト）** |

**数値による変化**:

| 値 | 動作 | メリット | デメリット |
|----|------|----------|----------|
| `false` | 割り込み無効 | AI応答が最後まで話される | ユーザーが割り込めない |
| `true` | 割り込み有効 | 自然な会話の流れ | 物音でAI応答が中断される |
| **未設定（推奨）** | サーバーのデフォルト動作 | バランスが良い | - |

**⚠️ 重要**: 
- 高齢者向けアプリでは**設定しない**ことを推奨
- コード側で `response_in_progress` フラグで制御する方が確実

---

### 完全な設定例（推奨値）

```python
self.session_config = {
    "modalities": ["audio", "text"],
    "instructions": self._load_conversation_instructions(),
    "voice": "shimmer",
    "input_audio_format": "pcm16",
    "output_audio_format": "pcm16",
    "input_audio_transcription": {
        "model": "whisper-1",
        "language": "ja"
    },
    "turn_detection": {
        "type": "server_vad",
        "threshold": 0.85,          # 物音に反応しにくく
        "prefix_padding_ms": 500,   # 発話の頭が切れない
        "silence_duration_ms": 1500 # ゆっくり話す人向け
    },
    "temperature": 0.7,
    "max_response_output_tokens": 150
    # interrupt_response は設定しない（デフォルト動作）
}
```

---

## 🎯 相槌・フィラー無視機能（新機能）

### 機能概要

ユーザーの「うーん」「えっと」「あー」などの相槌やフィラー（意味のない短い発話）を検知して、AIの応答をスキップする機能です。

**メリット**:
- AIが相槌に対して過剰に反応しなくなる
- 自然な会話の流れを保つ
- ユーザーが考えている間の間投詞を無視できる

### 判定ロジック

**ファイル**: `main.py`  
**メソッド**: `_is_filler_or_backchannel()`

#### 無視される発話

| 分類 | 例 | 判定基準 |
|------|---|---------|
| 相槌 | 「うん」「ええ」「はい」 | フィラーリストに一致 |
| フィラー | 「えっと」「あのー」「その」 | フィラーリストに一致 |
| 思考中の発話 | 「あー」「えー」「んー」「うーん」 | フィラーリストに一致 |
| 短すぎる発話 | 「あ」「お」 | 2文字以下 |
| 空文字 | （無音） | 空文字列 |

#### 登録されているフィラーワード

```python
FILLER_WORDS = [
    "うん", "ええ", "あー", "えー", "んー", "うーん",
    "えっと", "あのー", "その", "まあ", "ほら", "なんか",
    "へー", "ふーん", "はあ", "そうそう", "ああ", "おお",
]
```

### 動作例

```
ユーザー: 「うーん」
→ 🔇 相槌/フィラーを検知 - AI応答をスキップ

ユーザー: 「えっと、昨日は散歩に行きました」
→ ✅ 意味のある発話と判定 - AI応答を生成

ユーザー: 「ああ」
→ 🔇 相槌/フィラーを検知 - AI応答をスキップ
```

### カスタマイズ方法

#### フィラーワードを追加する

`main.py` の `FILLER_WORDS` リストに追加：

```python
FILLER_WORDS = [
    # ... 既存のリスト
    "ん",      # 追加
    "んん",    # 追加
    "えぇ",    # 追加
]
```

#### 短い発話の判定基準を変更

`_is_filler_or_backchannel()` メソッド内：

```python
# 非常に短い発話（2文字以下）は相槌と判定
if len(normalized) <= 2:  # ← この値を変更
    return True

# 例: 3文字以下にする
if len(normalized) <= 3:
    return True
```

#### 機能を無効化する

判定をコメントアウト：

```python
def on_transcription(text: str) -> None:
    self.user_messages.append(text)
    logger.info(f"ユーザー: {text}")

    if self._is_end_command(text):
        self.running = False
        asyncio.create_task(self.handler.stop_conversation())
        return

    # 以下をコメントアウトすると機能が無効化される
    # if self._is_filler_or_backchannel(text):
    #     logger.info(f"相槌またはフィラーのため応答をスキップ: '{text}'")
    #     return

    asyncio.create_task(queue_response(text))
```

### ログでの確認

機能が動作しているかログで確認できます：

```bash
python main.py

# 出力例
🔇 相槌/フィラーを検知: 'うーん' - AI応答をスキップします
相槌またはフィラーのため応答をスキップ: 'うーん'
```

### 注意事項

⚠️ **意味のある短い応答も無視される可能性**

例えば、「はい、そうです」という発話が「はい」だけと認識された場合、無視される可能性があります。

**対策**:
- VADの `silence_duration_ms` を長めに設定して、発話全体を捉える
- フィラーリストを厳選する

---

## 🔄 AI応答の自動キャンセル機能（新機能）

### 機能概要

ユーザーの新しい発話があった時、進行中のAI応答を自動的にキャンセルする機能です。

**メリット**:
- AIが何度も同じことを繰り返さなくなる
- ユーザーの割り込みに即座に対応
- 自然な会話のキャッチボールが実現

### 動作フロー

```
1. AI応答が生成中・再生中
   ↓
2. ユーザーが新しく話し始める
   ↓
3. 【自動】進行中のAI応答をキャンセル
   ↓
4. 新しいユーザー発話に対して応答生成
```

### 実装箇所

**ファイル**: `main.py` + `modules/audio_handler.py`

#### main.py の処理

```python
def on_transcription(text: str) -> None:
    # 【重要】ユーザーの新しい発話があったら、進行中のAI応答をキャンセル
    if self.handler.response_in_progress:
        logger.info("🛑 ユーザーの新しい発話を検知 - 進行中のAI応答をキャンセルします")
        asyncio.create_task(self.handler._cancel_active_response())
```

#### audio_handler.py の処理

```python
async def _cancel_active_response(self):
    """進行中の応答をキャンセル"""
    # 1. 音声出力を即座に停止
    self.suppress_audio_output = True
    
    # 2. サーバー側の応答生成をキャンセル
    if self.current_response_id:
        cancel_payload = {
            "type": "response.cancel",
            "response_id": self.current_response_id
        }
        await self.websocket.send(json.dumps(cancel_payload))
    
    # 3. フラグをリセット
    self.response_in_progress = False
```

### 動作例

```
状況: AIが「それは良かったですね。ところで...」と話し始めている

ユーザー: 「うん」（相槌）
→ 🛑 AI応答をキャンセル
→ 🔇 相槌なので新しい応答は生成しない

ユーザー: 「昨日散歩に行きました」
→ 🛑 AI応答をキャンセル
→ ✅ 新しい発話なので応答を生成
```

### ログでの確認

機能が動作しているかログで確認できます：

```bash
python main.py

# 出力例
🛑 ユーザーの新しい発話を検知 - 進行中のAI応答をキャンセルします
🛑 進行中の応答をキャンセル (ID: resp_abc123)
🔇 音声出力が抑制されています（キャンセル済み）
✅ 応答完了（キャンセル済み）
```

### トラブルシューティング

#### 症状: AI応答がキャンセルされない

**確認事項**:
1. `response_in_progress` フラグが正しく設定されているか
2. `_cancel_active_response()` が呼ばれているか（ログ確認）

**対策**:
```python
# main.py の on_transcription で確認
print(f"DEBUG: response_in_progress = {self.handler.response_in_progress}")
```

#### 症状: キャンセル後も音声が聞こえる

**原因**: 既にバッファされた音声データが再生される

**対策**: 
- `speak_delay_seconds` を長めに設定すると、キャンセルのタイミングが早くなる
- 音声出力バッファをクリアする処理を追加（高度）

---

## 📋 よくある問題と解決方法

### 問題1: AI応答が途中でプツッと切れる

**原因**:
- AI応答中にユーザーの物音や相槌を音声検知（VAD）が拾ってしまう
- VADが新しい発話と判断し、AI応答を中断してしまう
- 応答トークン数が少なすぎて文章が完結しない

**解決策**: 👉 [セクション1: 割り込み防止](#1-ai応答中の割り込み防止)

---

### 問題2: AIの話速が速すぎる

**原因**:
- プロンプトの指示が曖昧
- 音声再生前の待機時間が短い
- 応答間隔が短すぎて焦った印象

**解決策**: 👉 [セクション2: 話速の調整](#2-話速をゆっくりさせる設定)

---

## 🔧 調整箇所一覧

### 1. AI応答中の割り込み防止

**目的**: AI応答が途中で切れるのを防ぐ（最重要）

**ファイル**: `modules/audio_handler.py`  
**場所**: `_handle_api_response()` メソッド内、`input_audio_buffer.speech_started` の処理

#### 修正コード

```python
elif message_type == "input_audio_buffer.speech_started":
    logger.info("🎤 音声入力検知開始")
    
    # AI応答中の割り込みを抑制（応答が途中で切れるのを防ぐ）
    if self.response_in_progress:
        logger.info("⚠️ AI応答中のため、音声入力検知を抑制します")
        # 応答完了まで待つ（割り込みを許可しない）
        return
    
    self.last_speech_time = time.time()
```

#### パラメータ説明

| パラメータ | 説明 |
|-----------|------|
| `self.response_in_progress` | AIが応答生成中かどうかのフラグ |
| `return` | この音声入力イベントを無視して処理を中断 |

#### 効果

- ✅ AIが話している最中に物音を拾っても応答が中断されない
- ✅ ユーザーの相槌でAIの発話が切れない
- ✅ 最後まで文章を話し切る

#### ログ確認

```
⚠️ AI応答中のため、音声入力検知を抑制します
```

このログが出れば、割り込み防止が機能しています。

---

### 2. 話速をゆっくりさせる設定

**目的**: 高齢者が聞き取りやすいゆっくりとした話速を実現

#### 2-1. プロンプトの改善

**ファイル**: `modules/audio_handler.py`  
**場所**: `_load_conversation_instructions()` メソッド

##### 修正コード

```python
def _load_conversation_instructions(self) -> str:
    """会話指示を読み込み"""
    return (
        "あなたは高齢者と会話する優しい聞き役です。\n"
        "【重要】ゆっくり、はっきり、落ち着いた調子で話してください。"
        "1文ずつ区切って、間を取りながら話します。\n"
        "必ず1〜2文以内の短い応答で、相槌や共感を最優先してください。\n"
        "相手の言葉を復唱し、『そうですね』『それはいいですね』『なるほど』などを交えつつ、"
        "話の続きを促してください。\n"
        "沈黙が続くときは『最近の楽しいこと』『思い出話』『軽い脳トレ質問』など"
        "安全な話題を1つだけ提案します。焦らず、ゆったりと対話してください。"
    )
```

##### ポイント

| 指示 | 効果 |
|-----|------|
| 「ゆっくり、はっきり、落ち着いた調子で」 | 具体的な話し方の指示 |
| 「1文ずつ区切って、間を取りながら」 | リズムのコントロール |
| 「焦らず、ゆったりと対話」 | 全体のトーンを落ち着かせる |

---

#### 2-2. 音声再生前の待機時間

**ファイル**: `modules/audio_handler.py`  
**場所**: `__init__()` メソッド内の初期化部分

##### 修正コード

```python
self.speak_delay_seconds = 1.5  # AI音声再生前の待機時間（ゆっくり話すため長めに）
```

##### パラメータ

| 値 | 効果 |
|----|------|
| `1.0` (デフォルト) | 標準的な間 |
| `1.5` (推奨) | ゆったりとした間 |
| `2.0` (さらにゆっくり) | かなりゆっくりした印象 |

##### 効果

- ✅ AIが話し始める前に自然な間が生まれる
- ✅ 聞き手が準備する時間ができる

---

#### 2-3. 応答完了後のクールダウン時間

**ファイル**: `modules/audio_handler.py`  
**場所**: `_handle_api_response()` メソッド内、`response.done` の処理

##### 修正コード

```python
elif message_type == "response.done":
    logger.info("応答完了")
    self.response_in_progress = False
    self.response_cooldown_until = time.time() + 2.0  # ゆっくり会話するため少し短めに
    self.current_response_id = None
```

##### パラメータ

| 値 | 効果 |
|----|------|
| `3.0` | 会話のテンポが遅くなる（間が長い） |
| `2.0` (推奨) | 自然な会話のリズム |
| `1.5` | 少し早めの会話テンポ |

---

### 3. VAD（音声検知）設定の最適化

**目的**: 誤検知を減らし、ユーザーの発話を正確に捉える

**ファイル**: `modules/audio_handler.py`  
**場所**: `__init__()` メソッド内の `session_config`

#### 修正コード

```python
"turn_detection": {
    "type": "server_vad",
    "threshold": 0.85,          # 物音に反応しにくく（感度を下げる）
    "prefix_padding_ms": 500,   # 発話の頭が切れないよう長めに
    "silence_duration_ms": 1500 # ゆっくり話す人向けに長めに
}
```

#### パラメータ詳細

##### threshold（検知感度）

| 値 | 動作 | 推奨シーン |
|----|------|-----------|
| `0.5` | 非常に敏感（小さな音も拾う） | 静かな環境 |
| `0.75` | 標準的な感度 | 一般的な使用 |
| `0.85` | **推奨値**（物音に反応しにくい） | 生活音がある環境 |
| `0.9` | 鈍感（大きな声のみ） | 騒がしい環境 |

##### prefix_padding_ms（発話前バッファ）

| 値 | 効果 |
|----|------|
| `300ms` | 標準 |
| `500ms` | **推奨値** - 発話の頭が切れにくい |
| `700ms` | より安全（発話開始を確実にキャッチ） |

##### silence_duration_ms（無音判定時間）

| 値 | 効果 | 適用シーン |
|----|------|-----------|
| `500ms` | 短い - テンポが速い | 若年層向け |
| `900ms` | 標準 | 一般的な使用 |
| `1500ms` | **推奨値** - ゆっくり話す人向け | 高齢者向け |
| `2000ms` | 長い - かなりゆっくり | 発話が途切れがちな人 |

#### 効果

- ✅ 物音や咳払いで誤って発話と判定されない
- ✅ ユーザーの発話の頭と末尾が切れない
- ✅ ゆっくり話す人でも途中で切られない

---

### 4. 応答トークン数の調整

**目的**: 文章が途中で切れないようにする

**ファイル**: `modules/audio_handler.py`  
**場所**: `__init__()` メソッド内の `session_config`

#### 修正コード

```python
"max_response_output_tokens": 150  # ゆっくり話す余裕を持たせる
```

#### パラメータ

| 値 | 効果 |
|----|------|
| `50` | 非常に短い応答（相槌程度） |
| `100` | 短い応答（1〜2文） |
| `150` | **推奨値** - 適度な長さ |
| `200` | やや長い応答（説明が必要な場合） |

#### 効果

- ✅ 文章が途中で打ち切られない
- ✅ AIが言いたいことを最後まで伝えられる
- ⚠️ 注意: 大きすぎると話が長くなりすぎる

---

## 📊 設定値の一覧表

### 推奨設定（高齢者向け最適化）

| パラメータ | デフォルト | 推奨値 | 理由 |
|-----------|-----------|--------|------|
| `threshold` | 0.75 | **0.85** | 物音に反応しにくく |
| `prefix_padding_ms` | 300 | **500** | 発話の頭が切れない |
| `silence_duration_ms` | 900 | **1500** | ゆっくり話す人向け |
| `max_response_output_tokens` | 100 | **150** | 文章が完結する |
| `speak_delay_seconds` | 1.0 | **1.5** | 自然な間を作る |
| `response_cooldown` | 3.0 | **2.0** | 自然な会話リズム |

---

## 🎯 調整の手順

### Step 1: 基本設定を適用

まず、このガイドの推奨値をすべて適用してください。

### Step 2: 動作確認

```bash
python main.py
```

以下を確認：
- [ ] AIが話している最中に小さな音を立てても応答が切れない
- [ ] AIの話速がゆっくりになった
- [ ] 会話の自然なリズムが保たれている
- [ ] 文章が最後まで話される

### Step 3: 微調整

環境や利用者の特性に応じて以下を調整：

#### もっと話速を遅くしたい場合

```python
self.speak_delay_seconds = 2.0          # 1.5 → 2.0
"silence_duration_ms": 2000             # 1500 → 2000
```

#### 感度をもっと下げたい場合（物音が多い環境）

```python
"threshold": 0.9                        # 0.85 → 0.9
```

#### もっとテンポよく会話したい場合

```python
self.speak_delay_seconds = 1.0          # 1.5 → 1.0
"silence_duration_ms": 1200             # 1500 → 1200
self.response_cooldown_until = time.time() + 1.5  # 2.0 → 1.5
```

---

## 🔍 トラブルシューティング

### 症状: まだAI応答が途中で切れる

**確認事項**:
1. `self.response_in_progress`チェックが実装されているか
2. ログに「⚠️ AI応答中のため、音声入力検知を抑制します」が出ているか
3. `threshold`が0.85以上に設定されているか

**追加対策**:
```python
"threshold": 0.9  # さらに感度を下げる
```

---

### 症状: ユーザーの発話の頭が切れる

**確認事項**:
- `prefix_padding_ms`が500以上か

**追加対策**:
```python
"prefix_padding_ms": 700  # さらに長めに
```

---

### 症状: ユーザーがゆっくり話すと途中で切られる

**確認事項**:
- `silence_duration_ms`が1500以上か

**追加対策**:
```python
"silence_duration_ms": 2000  # さらに長めに
```

---

### 症状: AIの話速が変わらない

**確認事項**:
1. プロンプトが更新されているか確認
2. プログラムを再起動したか

**追加対策**:
```python
# プロンプトの冒頭に強調を追加
"【最重要】ゆっくり、ゆっくり話してください。1文ごとに間を取ります。\n"
```

---

## 📝 設定例

### 例1: 静かな自宅環境（標準的な高齢者）

```python
"turn_detection": {
    "threshold": 0.85,
    "prefix_padding_ms": 500,
    "silence_duration_ms": 1500
},
"max_response_output_tokens": 150,
self.speak_delay_seconds = 1.5
```

---

### 例2: 生活音が多い環境

```python
"turn_detection": {
    "threshold": 0.9,           # 感度をさらに下げる
    "prefix_padding_ms": 600,
    "silence_duration_ms": 1800
},
"max_response_output_tokens": 150,
self.speak_delay_seconds = 2.0
```

---

### 例3: 発話がゆっくりな利用者

```python
"turn_detection": {
    "threshold": 0.85,
    "prefix_padding_ms": 700,   # 発話の頭を確実にキャッチ
    "silence_duration_ms": 2500  # かなり長めに
},
"max_response_output_tokens": 120,  # 短めの応答
self.speak_delay_seconds = 2.0
```

---

### 例4: テンポよく会話したい場合

```python
"turn_detection": {
    "threshold": 0.8,
    "prefix_padding_ms": 400,
    "silence_duration_ms": 1000
},
"max_response_output_tokens": 100,
self.speak_delay_seconds = 1.0
```

---

## ⚠️ 注意事項

### 1. 設定変更後は必ず再起動

コード変更後は必ずプログラムを再起動してください。

```bash
# Ctrl+C で終了
python main.py  # 再起動
```

### 2. 一度に大きく変更しない

設定値は**少しずつ調整**してください。一度に大きく変更すると、どの設定が効いているか分からなくなります。

### 3. 利用者ごとに最適化

利用者の発話スピードや環境は異なります。実際に使いながら最適な値を見つけてください。

### 4. ログを確認

動作確認時は必ずログを確認し、意図通りに動作しているか確認してください。

---

## 📚 関連ドキュメント

- [システム仕様書](system_specification.md)
- [実装手順書](implementation_guide.md)
- [プロンプト設計](prompt_design.md)

---

**作成日**: 2025年9月30日  
**バージョン**: 1.0
